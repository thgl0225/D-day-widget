<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-day 카운터</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 변수 설정 (사용자 설정 가능) --- */
        :root {
            --theme-main: #ff80ab;  
            --theme-shadow-rgb: 255, 128, 171;  
            --dday-start-color: #ff99cc;  
            --dday-end-color: #ff80ab;
            --soft-bg: #fce4ec;  
            --modal-bg: #fff0f7;
            --warning-color: #ff4d4d; /* 경고 메시지 색상 추가 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* 기본 폰트: Gowun Batang (고운 바탕) 유지 */
            font-family: 'Gowun Batang', 'Poppins', sans-serif;  
            background: none;  
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
            position: relative;
        }

        /* --- 모달 (팝업창) 스타일 (설정 모달만 유지) --- */
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.15); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: var(--modal-bg); padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(var(--theme-shadow-rgb), 0.3); text-align: center; width: 150px; border: 2px solid var(--theme-main); transform: scale(0.95); }
        .modal-message { font-size: 11px; color: #444; margin-bottom: 15px; font-weight: 600; }
        .modal-button { 
            padding: 6px 15px; background: var(--theme-main); color: white; border: none; border-radius: 15px; font-size: 10px; font-weight: 700; cursor: pointer; transition: background 0.2s; 
            font-family: 'Gowun Batang', sans-serif; 
        }
        .modal-button:hover { background: rgba(var(--theme-shadow-rgb), 0.8); }
        #settingsModal .modal-content { width: 170px; padding: 15px; }
        #settingsModal h4 { font-size: 13px; color: var(--theme-main); margin-bottom: 10px; font-weight: 700; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .setting-label { font-size: 10px; color: #555; font-weight: 600; }
        #settingsModal .modal-button { width: 100%; margin-top: 5px; padding: 8px; font-size: 11px; }
        #settingsModal input[type="color"] { width: 20px; height: 20px; padding: 0; border: 2px solid #ffffff; border-radius: 50%; cursor: pointer; background-color: var(--theme-main); margin-left: 10px; -webkit-appearance: none; -moz-appearance: none; appearance: none; box-shadow: 0 0 3px rgba(0, 0, 0, 0.2); }
        #settingsModal input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        #settingsModal input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
        
        /* --- 위젯 컨테이너 --- */
        .container { background: none; padding: 0; width: 100%; max-width: 180px; box-shadow: none; border: none; display: flex; flex-direction: column; align-items: center; }
        
        /* 들여쓰기 유지 */
        .input-group { margin-bottom: 8px; padding-left: 5px; }
        
        label { display: block; margin-bottom: 4px; color: var(--theme-main); font-weight: 700; font-size: 10px; letter-spacing: 0.5px; }
        #inputForm { background: #ffffff; border-radius: 12px; padding: 10px; box-shadow: 0 4px 10px rgba(var(--theme-shadow-rgb), 0.2); border: 2px solid var(--soft-bg); width: 100%; position: relative; }
        
        /* --- 경고 메시지 스타일 --- */
        #warningMessage {
            color: var(--warning-color);
            font-size: 11px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            display: none; /* 기본 숨김 */
            /* 폰트: Poppins 적용 */
            font-family: 'Poppins', sans-serif; 
        }

        /* --- 텍스트 및 날짜 입력 필드 스타일 --- */
        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 6px 10px;
            border: 2px solid var(--soft-bg);
            border-radius: 12px;
            font-size: 10px;
            background: #fffafa;
            transition: border-color 0.3s, box-shadow 0.3s;
            /* 입력창 폰트를 Poppins로 통일 */
            font-family: 'Poppins', sans-serif;  
        }

        input:focus { outline: none; border-color: var(--theme-main); box-shadow: 0 0 5px rgba(var(--theme-shadow-rgb), 0.5); }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: none; cursor: pointer; opacity: 1.0; }
        
        /* --- 설정 버튼 (폰트 통일) --- */
        button:not(.setting-btn, .modal-button) {
            width: 100%;
            padding: 8px;
            background: var(--theme-main);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(var(--theme-shadow-rgb), 0.4);
            margin-top: 4px;  
            cursor: pointer;
            font-family: 'Gowun Batang', sans-serif;  
        }

        button:not(.setting-btn, .modal-button):hover { transform: translateY(-2px); background: rgba(var(--theme-shadow-rgb), 0.8); box-shadow: 0 6px 12px rgba(var(--theme-shadow-rgb), 0.6); }

        /* --- D-day 표시 영역 --- */
        .dday-display { margin-top: 12px; text-align: center; display: none; border-radius: 20px; padding: 12px; background: #fff; box-shadow: 0 4px 12px rgba(var(--theme-shadow-rgb), 0.3); border: 2px dashed var(--soft-bg); width: 100%; position: relative; }
        .dday-display.show { display: block; }
        
        /* 간격 및 제목 크기 유지 */
        .event-name { 
            font-size: 15px; 
            color: #444; 
            margin-bottom: 3px; 
            font-weight: 600; 
        }
        
        /* D-day 숫자 폰트: Poppins (Bold) 적용 */
        .dday-number { 
            font-size: 30px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;  
            background: linear-gradient(135deg, var(--dday-start-color) 0%, var(--dday-end-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 3px 0;  
            text-shadow: 0 0 5px rgba(var(--theme-shadow-rgb), 0.4);
        }
        
        .target-date { font-size: 11px; color: #777; margin-top: 6px; font-style: italic; }
        
        /* --- 설정 톱니바퀴 버튼 --- */
        .setting-btn { background: none; color: var(--theme-main); font-size: 14px; opacity: 0.6; font-weight: normal; width: auto; padding: 0; margin: 0; border: none; box-shadow: none; position: absolute; top: 4px; right: 4px; transition: opacity 0.2s, transform 0.2s; cursor: pointer; z-index: 50; }
        .setting-btn:hover { opacity: 1.0; color: var(--theme-main); transform: rotate(15deg); }
        
    </style>
</head>
<body onload="loadThemeColor()">
    <div class="container">
        
        <div id="inputForm">
            <button class="setting-btn" onclick="showSettingsModal()">⚙️</button>
            
            <div id="warningMessage"></div>

            <div class="input-group">
                <label for="eventName">제목</label>
                <input type="text" id="eventName" placeholder="예: 생일, 중요한 날">
            </div>
            <div class="input-group">
                <label for="targetDate">날짜</label>
                <input type="date" id="targetDate">
            </div>
            
            <button onclick="setDday()">D-day 설정</button>
        </div>

        <div id="ddayDisplay" class="dday-display">
            <button class="setting-btn" onclick="showSettingsModal()">⚙️</button>
            <div class="event-name" id="displayEventName"></div>
            <div class="dday-number" id="ddayNumber"></div>
            <div class="target-date" id="displayTargetDate"></div>
        </div>
    </div>
    
    <div id="settingsModal" class="modal-backdrop" onclick="hideModal(event, 'settingsModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h4>위젯 설정</h4>
            <div class="setting-row">
                <span class="setting-label">테마 색상 변경</span>
                <input type="color" id="themeColor" value="#ff80ab" oninput="updateThemeColor(true)">
            </div>
            <button class="modal-button" onclick="resetDday()">입력 초기화 (재설정)</button>
            <button class="modal-button" onclick="hideModal(null, 'settingsModal')" style="margin-top: 10px;">닫기</button>
        </div>
    </div>

    <script>
        const data = { eventName: '', targetDate: '' };
        const root = document.documentElement;
        const D_DAY_KEY = 'ddayData';
        const COLOR_KEY = 'ddayThemeColor';
        const warningEl = document.getElementById('warningMessage'); // 경고 메시지 요소 변수

        let ddayInterval; // 실시간 업데이트를 위한 전역 변수
        
        // --- 1. 색상 관련 함수 ---
        function hexToRgb(hex) {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });

            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `${r}, ${g}, ${b}`;
        }
        
        function updateThemeColor(save = false) {
            const newColor = document.getElementById('themeColor').value;
            const rgb = hexToRgb(newColor);
            
            root.style.setProperty('--theme-main', newColor);
            root.style.setProperty('--theme-shadow-rgb', rgb);
            root.style.setProperty('--dday-start-color', newColor + '99'); 
            root.style.setProperty('--dday-end-color', newColor); 
            
            if (save) {
                localStorage.setItem(COLOR_KEY, newColor);
            }
        }

        function loadThemeColor() {
            const savedColor = localStorage.getItem(COLOR_KEY);
            if (savedColor) {
                document.getElementById('themeColor').value = savedColor;
                updateThemeColor(false); // 로드 시에는 저장하지 않음
            } else {
                // 저장된 색상이 없으면 기본값 적용
                updateThemeColor(false);
            }
        }

        // --- 2. 모달 관련 함수 (설정 모달만 유지) ---
        
        // 경고 메시지 표시 함수
        function showWarning(message) {
            warningEl.textContent = message;
            warningEl.style.display = 'block';
            
            // 3초 후 경고 메시지 자동 숨김
            clearTimeout(warningEl.timer);
            warningEl.timer = setTimeout(() => {
                warningEl.style.display = 'none';
            }, 3000); 
        }

        function showSettingsModal() {
            // 모달을 열 때 현재 적용된 색상을 피커에 표시
            const currentColor = getComputedStyle(root).getPropertyValue('--theme-main').trim();
            document.getElementById('themeColor').value = currentColor;
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function hideModal(event, modalId) {
            const modal = document.getElementById(modalId);
            // 모달 백드롭을 클릭했을 때만 닫기 (이벤트가 없고, 함수를 직접 호출한 경우 포함)
            if (!event || event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // --- 3. D-day 로직 함수 ---

        // D-day 설정 및 로컬 스토리지 저장
        function setDday() {
            const eventName = document.getElementById('eventName').value.trim();
            const targetDate = document.getElementById('targetDate').value;
            
            warningEl.style.display = 'none'; // 성공 시 경고 메시지 초기화
            
            const hasTitle = eventName !== '';
            const hasDate = targetDate !== '';
            let message = '';

            if (!hasTitle && !hasDate) {
                // 1. 둘 다 입력되지 않았을 경우
                message = "제목과 날짜를 모두 입력해주세요.";
            } else if (!hasTitle && hasDate) {
                // 3. 날짜만 입력되었을 경우
                message = "제목을 입력해주세요.";
            } else if (hasTitle && !hasDate) {
                // 2. 제목만 입력되었을 경우
                message = "날짜를 입력해주세요.";
            }

            if (message !== '') {
                showWarning(message);
                return;
            }

            data.eventName = eventName;
            data.targetDate = targetDate;
            
            // 로컬 스토리지에 데이터 저장
            localStorage.setItem(D_DAY_KEY, JSON.stringify(data));
            
            // D-day를 설정하면 즉시 업데이트 시작
            if (ddayInterval) clearInterval(ddayInterval);
            updateDisplay();
            ddayInterval = setInterval(updateDisplay, 1000 * 60); // 1분마다 업데이트
        }

        // D-day 표시 업데이트 로직
        function updateDisplay() {
            if (!data.targetDate) return; // 데이터가 없으면 업데이트 안 함

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(data.targetDate);
            target.setHours(0, 0, 0, 0);
            
            const diffTime = target - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            document.getElementById('displayEventName').textContent = data.eventName;
            document.getElementById('displayTargetDate').textContent = target.toLocaleDateString('ko-KR');

            if (diffDays > 0) {
                document.getElementById('ddayNumber').textContent = `D-${diffDays}`;
            } else if (diffDays === 0) {
                document.getElementById('ddayNumber').textContent = 'D-DAY';
            } else {
                document.getElementById('ddayNumber').textContent = `D+${Math.abs(diffDays)}`;
            }

            document.getElementById('inputForm').style.display = 'none';
            document.getElementById('ddayDisplay').classList.add('show');
        }

        // 로컬 스토리지에서 D-day 데이터 로드
        function loadDday() {
            const savedData = localStorage.getItem(D_DAY_KEY);
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    data.eventName = parsedData.eventName;
                    data.targetDate = parsedData.targetDate;
                    
                    // 입력 폼에도 값 채우기
                    document.getElementById('eventName').value = data.eventName;
                    document.getElementById('targetDate').value = data.targetDate;

                    // 업데이트 시작
                    if (data.targetDate) {
                        if (ddayInterval) clearInterval(ddayInterval);
                        updateDisplay();
                        ddayInterval = setInterval(updateDisplay, 1000 * 60);
                        return true;
                    }
                } catch (e) {
                    console.error("Failed to parse D-day data from localStorage:", e);
                    localStorage.removeItem(D_DAY_KEY);
                }
            }
            return false;
        }

        // D-day 초기화 및 로컬 스토리지 데이터 제거
        function resetDday() {
            hideModal(null, 'settingsModal');
            document.getElementById('eventName').value = '';
            document.getElementById('targetDate').value = '';
            document.getElementById('inputForm').style.display = 'block';
            document.getElementById('ddayDisplay').classList.remove('show');
            warningEl.style.display = 'none'; // 경고 메시지 숨김
            
            if (ddayInterval) clearInterval(ddayInterval);
            data.eventName = '';
            data.targetDate = '';
            
            // 로컬 스토리지 데이터 제거
            localStorage.removeItem(D_DAY_KEY);
        }

        // --- 4. 초기화 실행 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadThemeColor(); // 저장된 색상 로드
            loadDday();       // 저장된 D-day 데이터 로드
        });
    </script>
</body>
    <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAIMb2vDpnvlLsAVmxjJN1ZyCj1QRWSI40",
    authDomain: "d-day-widget.firebaseapp.com",
    databaseURL: "https://d-day-widget-default-rtdb.firebaseio.com",
    projectId: "d-day-widget",
    storageBucket: "d-day-widget.firebasestorage.app",
    messagingSenderId: "467516533011",
    appId: "1:467516533011:web:4293cdaf51eca02d7f12e6"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
</html>
